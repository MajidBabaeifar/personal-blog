name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-info:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Get build size
      id: build-size
      run: |
        SIZE=$(du -sh dist | cut -f1)
        echo "size=$SIZE" >> $GITHUB_OUTPUT

    - name: Comment PR with build info
      uses: actions/github-script@v7
      continue-on-error: true
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const buildSize = '${{ steps.build-size.outputs.size }}';
          const comment = `## üöÄ Build Information

          ‚úÖ Build completed successfully!

          **Build Size:** ${buildSize}

          **Preview:** Your changes will be automatically deployed to Vercel once merged.

          ---
          *This comment was automatically generated by GitHub Actions.*`;

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  validate-content:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check for new blog posts
      id: check-posts
      run: |
        if git diff --name-only origin/master...HEAD | grep -q "src/content/blog/"; then
          echo "has_new_posts=true" >> $GITHUB_OUTPUT
        else
          echo "has_new_posts=false" >> $GITHUB_OUTPUT
        fi

    - name: Validate blog post frontmatter
      if: steps.check-posts.outputs.has_new_posts == 'true'
      run: |
        echo "Checking blog post frontmatter..."
        for file in src/content/blog/*.md; do
          if [ -f "$file" ]; then
            if ! grep -q "^title:" "$file"; then
              echo "‚ùå Missing title in $file"
              exit 1
            fi
            if ! grep -q "^description:" "$file"; then
              echo "‚ùå Missing description in $file"
              exit 1
            fi
            if ! grep -q "^pubDate:" "$file"; then
              echo "‚ùå Missing pubDate in $file"
              exit 1
            fi
            echo "‚úÖ $file has valid frontmatter"
          fi
        done
